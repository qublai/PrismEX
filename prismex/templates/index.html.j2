{# @QK #}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PrismEX Batch Report</title>
  <style>
    :root{--bg:#0b0e14;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--border:#1f2937;--low:#10b981;--medium:#f59e0b;--high:#ef4444;--critical:#a855f7}
    body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{margin:0 0 6px 0;font-size:20px}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:14px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 6px;text-align:left;font-size:13px;vertical-align:top}
    th{color:var(--muted);font-weight:600;cursor:pointer;user-select:none}
    a{color:inherit}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-size:12px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    input,select{background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}
    .lvl-low{border-color: rgba(16,185,129,.4)}
    .lvl-medium{border-color: rgba(245,158,11,.4)}
    .lvl-high{border-color: rgba(239,68,68,.4)}
    .lvl-critical{border-color: rgba(168,85,247,.4)}
    .hint{font-size:12px;color:var(--muted);margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PrismEX Batch Report</h1>
    <div class="muted">Generated by {{ batch.tool.name }} v{{ batch.tool.version }} • {{ batch.batch.count }} file(s) • {{ batch.batch.seconds }}s</div>

    <div class="controls">
      <input id="q" placeholder="Filter by filename / path..." style="min-width:280px" />
      <select id="minScore">
        <option value="0">Min score: 0</option>
        <option value="20">Min score: 20 (MEDIUM+)</option>
        <option value="50">Min score: 50 (HIGH+)</option>
        <option value="75">Min score: 75 (CRITICAL)</option>
      </select>
      <span class="hint">Click table headers to sort.</span>
    </div>

    <div class="card">
      <table id="t">
        <thead>
          <tr>
            <th data-k="score">Score</th>
            <th data-k="path">Target</th>
            <th data-k="type">Type</th>
            <th data-k="yara">YARA</th>
          </tr>
        </thead>
        <tbody>
          {% for r in batch.results %}
            {% set lvl = r.score.level if r.score else 'low' %}
            <tr class="lvl-{{ lvl }}" data-score="{{ r.score.value if r.score else 0 }}" data-path="{{ r.target.path|e }}">
              <td><span class="pill mono">{{ r.score.value if r.score else 0 }}/100</span> <span class="muted">{{ (r.score.level or '').upper() if r.score else '' }}</span></td>
              <td class="mono"><a href="{{ r._html_file }}">{{ r.target.path }}</a></td>
              <td>{{ r.target.type }}</td>
              <td>{{ (r.analysis.yara|length) if r.analysis.yara is defined and r.analysis.yara else 0 }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="hint">Sorting and filtering run locally in your browser; no external calls are made.</div>
  </div>

<script>
(function(){
  const table = document.getElementById('t');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  let sortKey = 'score';
  let sortDir = 'desc';

  function keyOf(tr, k){
    if(k === 'score') return parseInt(tr.getAttribute('data-score') || '0', 10);
    if(k === 'path') return (tr.getAttribute('data-path') || '').toLowerCase();
    if(k === 'type') return (tr.children[2].innerText || '').toLowerCase();
    if(k === 'yara') return parseInt(tr.children[3].innerText || '0', 10);
    return '';
  }

  function apply(){
    const q = (document.getElementById('q').value || '').toLowerCase().trim();
    const minScore = parseInt(document.getElementById('minScore').value || '0', 10);

    rows.forEach(tr => {
      const p = (tr.getAttribute('data-path') || '').toLowerCase();
      const s = parseInt(tr.getAttribute('data-score') || '0', 10);
      const show = (!q || p.includes(q)) && s >= minScore;
      tr.style.display = show ? '' : 'none';
    });

    const visible = rows.filter(r => r.style.display !== 'none');
    visible.sort((a,b) => {
      const ka = keyOf(a, sortKey);
      const kb = keyOf(b, sortKey);
      if(ka < kb) return sortDir === 'asc' ? -1 : 1;
      if(ka > kb) return sortDir === 'asc' ? 1 : -1;
      return 0;
    });

    visible.forEach(tr => tbody.appendChild(tr));
  }

  table.querySelectorAll('th[data-k]').forEach(th => {
    th.addEventListener('click', () => {
      const k = th.getAttribute('data-k');
      if(k === sortKey){
        sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
      } else {
        sortKey = k;
        sortDir = (k === 'path' || k === 'type') ? 'asc' : 'desc';
      }
      apply();
    });
  });

  document.getElementById('q').addEventListener('input', apply);
  document.getElementById('minScore').addEventListener('change', apply);

  apply();
})();
</script>
</body>
</html>
